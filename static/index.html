
<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Jarvik Chat</title>
  <style>
    body { background-color: black; color: green; font-family: monospace; padding: 1em; }
    select, input, button { margin: 0.5em 0; background: black; color: green; border: 1px solid green; }
    #spinner { display: none; }
  </style>
</head>
<body>
  <h1>ðŸ§  Jarvik Chat</h1>
  <label>Model:
    <select id="model">
      <option value="mistral">Mistral</option>
      <option value="gemma">Gemma</option>
      <option value="tinyllama">TinyLlama</option>
    </select>
  </label>
  <br />
  <label>Heslo: <input type="password" id="password" /></label><br />
  <textarea id="message" rows="4" cols="60" placeholder="Zadej dotaz..."></textarea><br />
  <button>Odeslat</button> <span id="spinner">ðŸ”„</span>
  <div id="output" style="margin-top:1em;"></div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('button');
      const input = document.querySelector('#message');
      const output = document.querySelector('#output');
      const modelSelect = document.querySelector('#model');
      const passwordInput = document.querySelector('#password');
      const spinner = document.querySelector('#spinner');

      const history = JSON.parse(sessionStorage.getItem('chatHistory') || '[]');
      history.forEach(msg => {
        const div = document.createElement('div');
        div.innerHTML = `<b>${msg.role}</b>: ${msg.content}`;
        output.appendChild(div);
      });

      async function startModel(model) {
        spinner.style.display = 'inline-block';
        await fetch('/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model })
        });
        spinner.style.display = 'none';
      }

      modelSelect.addEventListener('change', async (e) => {
        const selected = e.target.value;
        for (const model of ['mistral', 'gemma', 'tinyllama']) {
          if (model !== selected) {
            await fetch('/stop', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ model })
            });
          }
        }
        await startModel(selected);
      });

      form.addEventListener('click', async () => {
        const userInput = input.value.trim();
        if (!userInput) return;
        const user = passwordInput.value.trim();
        const model = modelSelect.value;

        const userDiv = document.createElement('div');
        userDiv.innerHTML = `<b>Ty</b>: ${userInput}`;
        output.appendChild(userDiv);
        input.value = '';
        output.scrollTop = output.scrollHeight;

        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: userInput, model, user })
        });
        const data = await response.json();

        const botDiv = document.createElement('div');
        botDiv.innerHTML = `<b>Jarvik</b>: ${data.response}`;
        output.appendChild(botDiv);

        history.push({ role: "Ty", content: userInput }, { role: "Jarvik", content: data.response });
        sessionStorage.setItem('chatHistory', JSON.stringify(history));
        output.scrollTop = output.scrollHeight;
      });
    });
  </script>
</body>
</html>
